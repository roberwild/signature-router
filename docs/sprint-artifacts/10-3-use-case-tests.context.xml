<?xml version="1.0" encoding="UTF-8"?>
<story-context id="signature-router-10-3-context" version="1.0">
  <metadata>
    <epicId>10</epicId>
    <storyId>10.3</storyId>
    <storyKey>10-3-use-case-tests</storyKey>
    <title>Use Case Tests - Testing Coverage >85%</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-29</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/10-3-use-case-tests.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Developer</asA>
    <iWant>Tests de use cases con mocks de ports</iWant>
    <soThat>Orquestación de casos de uso esté validada</soThat>
    
    <context>
      Esta story implementa tests unitarios completos para los use cases de la capa de aplicación, 
      usando mocks de los ports (repositories, services) para validar la orquestación de casos de uso 
      sin depender de infraestructura real (DB, Kafka, etc.).
      
      Source: Evaluación de Calidad identificó que el coverage de use cases es <30%, lo cual es crítico 
      porque los use cases orquestan toda la lógica de negocio.
      
      Business Value: Valida orquestación de casos de uso críticos, protege flujos de negocio contra regresión, 
      facilita refactoring seguro de use cases, cumple con estándares bancarios de testing.
    </context>

    <tasks>
      <task id="1" ac="AC1">
        <title>Create StartSignatureUseCaseImplTest</title>
        <subtasks>
          <subtask id="1.1">Crear StartSignatureUseCaseImplTest.java en src/test/java/com/bank/signature/application/usecase/</subtask>
          <subtask id="1.2">Mock: SignatureRequestRepository, RoutingService, ChallengeService, PseudonymizationService, TransactionHashService, DegradedModeManager, CustomerRateLimitService</subtask>
          <subtask id="1.3">Test: happy path (crear signature → evaluar routing → guardar → crear challenge)</subtask>
          <subtask id="1.4">Test: pseudonymization de customer ID</subtask>
          <subtask id="1.5">Test: cálculo de hash de transaction context</subtask>
          <subtask id="1.6">Test: evaluación de routing rules</subtask>
          <subtask id="1.7">Test: creación de challenge para canal seleccionado</subtask>
          <subtask id="1.8">Test: persistencia de signature request</subtask>
          <subtask id="1.9">Test: degraded mode handling (PENDING_DEGRADED status)</subtask>
          <subtask id="1.10">Test: rate limiting (customer-specific)</subtask>
          <subtask id="1.11">Test: validación de input (customer ID nulo → exception)</subtask>
          <subtask id="1.12">Verificar interacciones con mocks (save, evaluate, createChallenge)</subtask>
          <subtask id="1.13">Ejecutar tests y verificar coverage >85%</subtask>
        </subtasks>
        <filesToCreate>
          <file>src/test/java/com/bank/signature/application/usecase/StartSignatureUseCaseImplTest.java</file>
        </filesToCreate>
      </task>
      
      <task id="2" ac="AC2">
        <title>Create CompleteSignatureUseCaseImplTest</title>
        <subtasks>
          <subtask id="2.1">Crear CompleteSignatureUseCaseImplTest.java en src/test/java/com/bank/signature/application/usecase/</subtask>
          <subtask id="2.2">Mock: SignatureRequestRepository, EventPublisher, CorrelationIdProvider, MeterRegistry</subtask>
          <subtask id="2.3">Test: happy path (código correcto → SIGNED)</subtask>
          <subtask id="2.4">Test: código incorrecto → error (max 3 intentos)</subtask>
          <subtask id="2.5">Test: challenge expirado → exception</subtask>
          <subtask id="2.6">Test: challenge no encontrado → NotFoundException</subtask>
          <subtask id="2.7">Test: challenge no en estado SENT → InvalidStateTransitionException</subtask>
          <subtask id="2.8">Test: max attempts exceeded → challenge marcado como FAILED</subtask>
          <subtask id="2.9">Test: publicación de evento (SignatureCompletedEvent)</subtask>
          <subtask id="2.10">Test: métricas registradas (success/failure counters)</subtask>
          <subtask id="2.11">Verificar interacciones con mocks (findById, save, publish)</subtask>
          <subtask id="2.12">Ejecutar tests y verificar coverage >85%</subtask>
        </subtasks>
        <filesToCreate>
          <file>src/test/java/com/bank/signature/application/usecase/CompleteSignatureUseCaseImplTest.java</file>
        </filesToCreate>
      </task>
      
      <task id="3" ac="AC3">
        <title>Create ManageRoutingRulesUseCaseImplTest</title>
        <subtasks>
          <subtask id="3.1">Crear ManageRoutingRulesUseCaseImplTest.java en src/test/java/com/bank/signature/application/usecase/</subtask>
          <subtask id="3.2">Mock: RoutingRuleRepository, SpelValidatorService, RoutingRuleAuditService, RoutingRuleMapper</subtask>
          <subtask id="3.3">Test: createRule - happy path</subtask>
          <subtask id="3.4">Test: createRule - SpEL inválido → InvalidSpelExpressionException</subtask>
          <subtask id="3.5">Test: updateRule - happy path</subtask>
          <subtask id="3.6">Test: updateRule - rule no encontrado → NotFoundException</subtask>
          <subtask id="3.7">Test: updateRule - SpEL inválido → InvalidSpelExpressionException</subtask>
          <subtask id="3.8">Test: getRule - happy path</subtask>
          <subtask id="3.9">Test: getRule - rule no encontrado → NotFoundException</subtask>
          <subtask id="3.10">Test: listRules - happy path</subtask>
          <subtask id="3.11">Test: listRules - lista vacía</subtask>
          <subtask id="3.12">Test: deleteRule - happy path</subtask>
          <subtask id="3.13">Test: deleteRule - rule no encontrado → NotFoundException</subtask>
          <subtask id="3.14">Verificar interacciones con mocks (save, findById, findAllOrderedByPriority, validate, auditService.save)</subtask>
          <subtask id="3.15">Ejecutar tests y verificar coverage >85%</subtask>
        </subtasks>
        <filesToCreate>
          <file>src/test/java/com/bank/signature/application/usecase/ManageRoutingRulesUseCaseImplTest.java</file>
        </filesToCreate>
      </task>
      
      <task id="4" ac="AC4">
        <title>Verify JaCoCo Coverage</title>
        <subtasks>
          <subtask id="4.1">Ejecutar mvn clean test jacoco:report</subtask>
          <subtask id="4.2">Revisar reporte en target/site/jacoco/index.html</subtask>
          <subtask id="4.3">Verificar Application layer >85% line coverage</subtask>
          <subtask id="4.4">Verificar StartSignatureUseCaseImpl >85%, CompleteSignatureUseCaseImpl >85%, ManageRoutingRulesUseCaseImpl >85%</subtask>
        </subtasks>
      </task>
      
      <task id="5" ac="AC5">
        <title>Verify Test Performance</title>
        <subtasks>
          <subtask id="5.1">Ejecutar mvn test -Dtest=*UseCase*Test</subtask>
          <subtask id="5.2">Verificar que todos los tests ejecutan en <10s total</subtask>
          <subtask id="5.3">Verificar que tests son determinísticos (sin flakiness)</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <title>StartSignatureUseCaseImpl Tests</title>
      <given>Use case StartSignatureUseCaseImpl</given>
      <when>Ejecuto StartSignatureUseCaseImplTest.java</when>
      <then>
        Coverage >85% con tests para: happy path, pseudonymization, cálculo de hash, evaluación de routing, 
        creación de challenge, persistencia, degraded mode handling, rate limiting, validación de input
      </then>
      <verification>Mocks verifican interacciones (save, evaluate, createChallenge), tests ejecutan en <10s</verification>
    </criterion>

    <criterion id="AC2">
      <title>CompleteSignatureUseCaseImpl Tests</title>
      <given>Use case CompleteSignatureUseCaseImpl</given>
      <when>Ejecuto CompleteSignatureUseCaseImplTest.java</when>
      <then>
        Coverage >85% con tests para: happy path, código incorrecto (max 3 intentos), challenge expirado, 
        challenge no encontrado, challenge no en estado SENT, max attempts exceeded, publicación de evento, métricas
      </then>
      <verification>Mocks verifican interacciones (findById, save, publish), tests ejecutan en <10s</verification>
    </criterion>

    <criterion id="AC3">
      <title>ManageRoutingRulesUseCaseImpl Tests</title>
      <given>Use case ManageRoutingRulesUseCaseImpl</given>
      <when>Ejecuto ManageRoutingRulesUseCaseImplTest.java</when>
      <then>
        Coverage >85% con tests para: createRule (happy path, SpEL inválido), updateRule (happy path, not found, SpEL inválido), 
        getRule (happy path, not found), listRules (happy path, lista vacía), deleteRule (happy path, not found)
      </then>
      <verification>Mocks verifican interacciones (save, findById, findAllOrderedByPriority, validate, auditService.save), tests ejecutan en <10s</verification>
    </criterion>

    <criterion id="AC4">
      <title>JaCoCo Coverage Report</title>
      <given>Todos los tests ejecutados</given>
      <when>Reviso reporte JaCoCo</when>
      <then>
        Application layer muestra: Line coverage >85%, Branch coverage >80%, StartSignatureUseCaseImpl >85%, 
        CompleteSignatureUseCaseImpl >85%, ManageRoutingRulesUseCaseImpl >85%
      </then>
      <verification>Reporte generado en target/site/jacoco/index.html</verification>
    </criterion>

    <criterion id="AC5">
      <title>Test Execution Performance</title>
      <given>Suite completa de tests de use cases</given>
      <when>Ejecuto mvn test -Dtest=*UseCase*Test</when>
      <then>Todos los tests ejecutan en <10s total, tests son determinísticos (sin flakiness)</then>
      <verification>Ejecución completa en <10s</verification>
    </criterion>
  </acceptanceCriteria>

  <codeArtifacts>
    <artifact type="test" package="com.bank.signature.application.usecase" name="StartSignatureUseCaseImplTest">
      <description>Unit tests for StartSignatureUseCaseImpl use case</description>
      <dependencies>
        <dependency>JUnit 5</dependency>
        <dependency>Mockito</dependency>
        <dependency>AssertJ</dependency>
        <dependency>com.bank.signature.application.usecase.StartSignatureUseCaseImpl</dependency>
        <dependency>com.bank.signature.domain.port.outbound.SignatureRequestRepository</dependency>
        <dependency>com.bank.signature.domain.service.RoutingService</dependency>
        <dependency>com.bank.signature.domain.service.ChallengeService</dependency>
      </dependencies>
    </artifact>
    
    <artifact type="test" package="com.bank.signature.application.usecase" name="CompleteSignatureUseCaseImplTest">
      <description>Unit tests for CompleteSignatureUseCaseImpl use case</description>
      <dependencies>
        <dependency>JUnit 5</dependency>
        <dependency>Mockito</dependency>
        <dependency>AssertJ</dependency>
        <dependency>com.bank.signature.application.usecase.CompleteSignatureUseCaseImpl</dependency>
        <dependency>com.bank.signature.domain.port.outbound.SignatureRequestRepository</dependency>
        <dependency>com.bank.signature.domain.port.outbound.EventPublisher</dependency>
      </dependencies>
    </artifact>
    
    <artifact type="test" package="com.bank.signature.application.usecase" name="ManageRoutingRulesUseCaseImplTest">
      <description>Unit tests for ManageRoutingRulesUseCaseImpl use case</description>
      <dependencies>
        <dependency>JUnit 5</dependency>
        <dependency>Mockito</dependency>
        <dependency>AssertJ</dependency>
        <dependency>com.bank.signature.application.usecase.ManageRoutingRulesUseCaseImpl</dependency>
        <dependency>com.bank.signature.domain.port.outbound.RoutingRuleRepository</dependency>
        <dependency>com.bank.signature.domain.service.SpelValidatorService</dependency>
      </dependencies>
    </artifact>
  </codeArtifacts>

  <constraints>
    <constraint>Tests DEBEN usar mocks (no DB ni Kafka real)</constraint>
    <constraint>Tests deben ejecutar en <10s total (sin I/O)</constraint>
    <constraint>Tests deben ser determinísticos (sin flakiness)</constraint>
    <constraint>Coverage mínimo: StartSignatureUseCaseImpl >85%, CompleteSignatureUseCaseImpl >85%, ManageRoutingRulesUseCaseImpl >85%</constraint>
    <constraint>Mocks deben verificar interacciones (verify() calls)</constraint>
  </constraints>
</story-context>
