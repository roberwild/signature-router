<?xml version="1.0" encoding="UTF-8"?>
<story-context id="signature-router-10-2-context" version="1.0">
  <metadata>
    <epicId>10</epicId>
    <storyId>10.2</storyId>
    <storyKey>10-2-domain-layer-tests</storyKey>
    <title>Domain Layer Tests - Testing Coverage >90%</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-29</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/10-2-domain-layer-tests.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Developer</asA>
    <iWant>>90% coverage en capa de dominio</iWant>
    <soThat>Reglas de negocio críticas estén protegidas contra regresión</soThat>
    
    <context>
      Esta story implementa tests unitarios completos para la capa de dominio (aggregates y value objects), 
      asegurando que todas las reglas de negocio críticas estén cubiertas por tests. El dominio es puro 
      (sin dependencias de frameworks), por lo que los tests son rápidos y no requieren mocks.
      
      Source: Evaluación de Calidad identificó que el coverage de dominio es <50%, lo cual es crítico 
      porque el dominio contiene las reglas de negocio más importantes del sistema.
      
      Business Value: Protege reglas de negocio críticas contra regresión, facilita refactoring seguro 
      del dominio, documenta comportamiento esperado del dominio, cumple con estándares bancarios de testing.
    </context>

    <tasks>
      <task id="1" ac="AC1">
        <title>Create SignatureRequestTest</title>
        <subtasks>
          <subtask id="1.1">Crear SignatureRequestTest.java en src/test/java/com/bank/signature/domain/model/aggregate/</subtask>
          <subtask id="1.2">Test: crear signature request con builder</subtask>
          <subtask id="1.3">Test: crear challenge (validar solo 1 activo)</subtask>
          <subtask id="1.4">Test: no permitir múltiples challenges activos (ChallengeAlreadyActiveException)</subtask>
          <subtask id="1.5">Test: transiciones de estado válidas (PENDING → SIGNED → COMPLETED)</subtask>
          <subtask id="1.6">Test: transiciones de estado inválidas (InvalidStateTransitionException)</subtask>
          <subtask id="1.7">Test: expiración por TTL (isExpired())</subtask>
          <subtask id="1.8">Test: abortar signature request (abort())</subtask>
          <subtask id="1.9">Test: validar challenge pertenece a request (ChallengeNotBelongsException)</subtask>
          <subtask id="1.10">Test: agregar eventos al routing timeline</subtask>
          <subtask id="1.11">Test: validar TTL no excedido antes de completar (TtlNotExceededException)</subtask>
          <subtask id="1.12">Ejecutar tests y verificar coverage >95%</subtask>
        </subtasks>
        <filesToCreate>
          <file>src/test/java/com/bank/signature/domain/model/aggregate/SignatureRequestTest.java</file>
        </filesToCreate>
      </task>
      
      <task id="2" ac="AC2">
        <title>Create SignatureChallengeTest</title>
        <subtasks>
          <subtask id="2.1">Crear SignatureChallengeTest.java en src/test/java/com/bank/signature/domain/model/entity/</subtask>
          <subtask id="2.2">Test: crear challenge con código generado</subtask>
          <subtask id="2.3">Test: validar código correcto (validateCode())</subtask>
          <subtask id="2.4">Test: validar código incorrecto (retorna false)</subtask>
          <subtask id="2.5">Test: expirar challenge por timeout (isExpired())</subtask>
          <subtask id="2.6">Test: marcar como SENT (markAsSent())</subtask>
          <subtask id="2.7">Test: marcar como COMPLETED (markAsCompleted())</subtask>
          <subtask id="2.8">Test: marcar como FAILED (markAsFailed())</subtask>
          <subtask id="2.9">Test: validar transiciones de estado válidas</subtask>
          <subtask id="2.10">Test: validar transiciones de estado inválidas</subtask>
          <subtask id="2.11">Ejecutar tests y verificar coverage >90%</subtask>
        </subtasks>
        <filesToCreate>
          <file>src/test/java/com/bank/signature/domain/model/entity/SignatureChallengeTest.java</file>
        </filesToCreate>
      </task>
      
      <task id="3" ac="AC3">
        <title>Create RoutingRuleTest</title>
        <subtasks>
          <subtask id="3.1">Crear RoutingRuleTest.java en src/test/java/com/bank/signature/domain/model/aggregate/</subtask>
          <subtask id="3.2">Test: crear routing rule con builder</subtask>
          <subtask id="3.3">Test: validar condición SpEL no nula</subtask>
          <subtask id="3.4">Test: validar target channel no nulo</subtask>
          <subtask id="3.5">Test: validar priority no nulo</subtask>
          <subtask id="3.6">Test: habilitar/deshabilitar rule (enable(), disable())</subtask>
          <subtask id="3.7">Test: actualizar condición SpEL</subtask>
          <subtask id="3.8">Test: actualizar target channel</subtask>
          <subtask id="3.9">Test: actualizar priority</subtask>
          <subtask id="3.10">Ejecutar tests y verificar coverage >90%</subtask>
        </subtasks>
        <filesToCreate>
          <file>src/test/java/com/bank/signature/domain/model/aggregate/RoutingRuleTest.java</file>
        </filesToCreate>
      </task>
      
      <task id="4" ac="AC4">
        <title>Complete Value Objects Tests</title>
        <subtasks>
          <subtask id="4.1">Revisar tests existentes de value objects (MoneyTest, TransactionContextTest, etc.)</subtask>
          <subtask id="4.2">Completar tests faltantes para TransactionContext (validación hash SHA256)</subtask>
          <subtask id="4.3">Completar tests faltantes para Money (métodos add, multiply)</subtask>
          <subtask id="4.4">Verificar coverage 100% para todos los value objects</subtask>
        </subtasks>
        <filesToModify>
          <file>src/test/java/com/bank/signature/domain/model/valueobject/TransactionContextTest.java</file>
          <file>src/test/java/com/bank/signature/domain/model/valueobject/MoneyTest.java</file>
        </filesToModify>
      </task>
      
      <task id="5" ac="AC5">
        <title>Verify JaCoCo Coverage</title>
        <subtasks>
          <subtask id="5.1">Ejecutar mvn clean test jacoco:report</subtask>
          <subtask id="5.2">Revisar reporte en target/site/jacoco/index.html</subtask>
          <subtask id="5.3">Verificar Domain layer >90% line coverage</subtask>
          <subtask id="5.4">Verificar SignatureRequest >95%, SignatureChallenge >90%, RoutingRule >90%</subtask>
          <subtask id="5.5">Verificar Value Objects 100% coverage</subtask>
        </subtasks>
      </task>
      
      <task id="6" ac="AC6">
        <title>Verify Test Performance</title>
        <subtasks>
          <subtask id="6.1">Ejecutar mvn test -Dtest=*Domain*Test</subtask>
          <subtask id="6.2">Verificar que todos los tests ejecutan en <5s total</subtask>
          <subtask id="6.3">Verificar que tests son determinísticos (sin flakiness)</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <title>SignatureRequest Aggregate Tests</title>
      <given>Aggregate SignatureRequest</given>
      <when>Ejecuto SignatureRequestTest.java</when>
      <then>
        Coverage >95% con tests para: crear signature request, crear challenge (validar solo 1 activo), 
        no permitir múltiples challenges activos, transiciones de estado válidas/inválidas, expiración por TTL, 
        abortar signature request, validar challenge pertenece a request, agregar eventos al routing timeline, 
        validar TTL no excedido antes de completar
      </then>
      <verification>Tests ejecutan en <1s, coverage >95%</verification>
    </criterion>

    <criterion id="AC2">
      <title>SignatureChallenge Entity Tests</title>
      <given>Entity SignatureChallenge</given>
      <when>Ejecuto SignatureChallengeTest.java</when>
      <then>
        Coverage >90% con tests para: crear challenge con código generado, validar código correcto/incorrecto, 
        expirar challenge por timeout, marcar como SENT/COMPLETED/FAILED, validar transiciones de estado válidas/inválidas
      </then>
      <verification>Tests ejecutan en <1s, coverage >90%</verification>
    </criterion>

    <criterion id="AC3">
      <title>RoutingRule Aggregate Tests</title>
      <given>Aggregate RoutingRule</given>
      <when>Ejecuto RoutingRuleTest.java</when>
      <then>
        Coverage >90% con tests para: crear routing rule con builder, validar condición SpEL no nula, 
        validar target channel no nulo, validar priority no nulo, habilitar/deshabilitar rule, 
        actualizar condición SpEL/target channel/priority
      </then>
      <verification>Tests ejecutan en <1s, coverage >90%</verification>
    </criterion>

    <criterion id="AC4">
      <title>Value Objects Tests (100% Coverage)</title>
      <given>Value Objects existentes</given>
      <when>Ejecuto tests unitarios</when>
      <then>
        Coverage 100% con tests para: TransactionContext (validación hash SHA256), Money (métodos add, multiply), 
        otros value objects (ChannelType, ProviderType, SignatureStatus, ChallengeStatus, ProviderResult, HealthStatus)
      </then>
      <verification>Tests ejecutan en <1s, coverage 100%</verification>
    </criterion>

    <criterion id="AC5">
      <title>JaCoCo Coverage Report</title>
      <given>Todos los tests ejecutados</given>
      <when>Reviso reporte JaCoCo</when>
      <then>
        Domain layer muestra: Line coverage >90%, Branch coverage >85%, SignatureRequest >95%, 
        SignatureChallenge >90%, RoutingRule >90%, Value Objects 100%
      </then>
      <verification>Reporte generado en target/site/jacoco/index.html</verification>
    </criterion>

    <criterion id="AC6">
      <title>Test Execution Performance</title>
      <given>Suite completa de tests de dominio</given>
      <when>Ejecuto mvn test -Dtest=*Domain*Test</when>
      <then>Todos los tests ejecutan en <5s total, tests son determinísticos (sin flakiness)</then>
      <verification>Ejecución completa en <5s</verification>
    </criterion>
  </acceptanceCriteria>

  <codeArtifacts>
    <artifact type="test" package="com.bank.signature.domain.model.aggregate" name="SignatureRequestTest">
      <description>Unit tests for SignatureRequest aggregate root</description>
      <dependencies>
        <dependency>JUnit 5</dependency>
        <dependency>AssertJ</dependency>
        <dependency>com.bank.signature.domain.model.aggregate.SignatureRequest</dependency>
        <dependency>com.bank.signature.domain.model.entity.SignatureChallenge</dependency>
        <dependency>com.bank.signature.domain.exception.*</dependency>
      </dependencies>
    </artifact>
    
    <artifact type="test" package="com.bank.signature.domain.model.entity" name="SignatureChallengeTest">
      <description>Unit tests for SignatureChallenge entity</description>
      <dependencies>
        <dependency>JUnit 5</dependency>
        <dependency>AssertJ</dependency>
        <dependency>com.bank.signature.domain.model.entity.SignatureChallenge</dependency>
        <dependency>com.bank.signature.domain.exception.*</dependency>
      </dependencies>
    </artifact>
    
    <artifact type="test" package="com.bank.signature.domain.model.aggregate" name="RoutingRuleTest">
      <description>Unit tests for RoutingRule aggregate root</description>
      <dependencies>
        <dependency>JUnit 5</dependency>
        <dependency>AssertJ</dependency>
        <dependency>com.bank.signature.domain.model.aggregate.RoutingRule</dependency>
      </dependencies>
    </artifact>
  </codeArtifacts>

  <constraints>
    <constraint>Tests NO deben usar mocks (dominio puro, sin dependencias)</constraint>
    <constraint>Tests deben ejecutar en <5s total (sin I/O)</constraint>
    <constraint>Tests deben ser determinísticos (sin flakiness)</constraint>
    <constraint>Coverage mínimo: SignatureRequest >95%, SignatureChallenge >90%, RoutingRule >90%, Value Objects 100%</constraint>
  </constraints>
</story-context>
