# Epic 10: Migration Guide (v1 â†’ v2)

## ğŸ“‹ Overview

This document explains what happened to Epic 10 v1 (failed Composer implementation) and how to proceed with Epic 10 v2 (revised & reduced scope).

---

## âŒ What Happened: Epic 10 v1 Failure

### Timeline
1. **Quality Evaluation Report** generated by Claude Code (mobile)
2. **Epic 10 v1** created based on full report (15 stories, 6-8 months)
3. **Implementation attempted** with Composer (experimental model)
4. **Result:** 3 hours of work, broken tests, errors everywhere
5. **Recovery:** Stashed everything, reverted to stable state

### Why It Failed
- âŒ Used Composer without supervision
- âŒ Tried to implement too much (15 stories)
- âŒ Duplicated work already done (idempotency, SpEL security)
- âŒ No incremental validation
- âŒ Tests written but not executing correctly

---

## ğŸ—ƒï¸ Epic 10 v1 Backup Location

All Epic 10 v1 work is safely stored in Git stash:

```powershell
# List stashes
git stash list

# Expected output:
stash@{0}: On main: BACKUP_EPIC_10_antes_de_revertir_20251129_144919

# To inspect (DON'T apply to main):
git stash show stash@{0} --stat

# To review specific files:
git stash show stash@{0} -p -- path/to/file.java
```

### What's in the Stash

**Modified Files:**
- Controllers (AdminRuleController, SecurityAuditController, SignatureController, etc.)
- GlobalExceptionHandler
- ErrorResponse
- IdempotencyCleanupJob (this one we kept - it was good)

**New Files:**
- ErrorCodeCatalog.java
- docs/ERROR_CODES.md
- Database constraint migrations (Liquibase)
- Various tests (DatabaseConstraintsIntegrationTest, ErrorCodeCatalogTest, etc.)

**Should You Use It?**
- âŒ **NO** - Don't apply the stash wholesale
- âœ… **MAYBE** - Review specific files if needed for reference
- âœ… **YES** - Some ideas might be salvageable (error codes, constraints)

---

## âœ… Epic 10 v2: The New Plan

### What Changed

| Aspect | v1 (Original) | v2 (Revised) |
|--------|--------------|--------------|
| **Duration** | 6-8 months | 5-6 weeks |
| **Stories** | 15 stories | 4 stories |
| **Scope** | Everything in quality report | Only critical gaps |
| **Approach** | Composer auto-pilot | Manual with supervision |
| **Risk** | High | Low |

### What Was Removed (Already Done)

These were in Epic 10 v1 but are **already implemented**:

1. âœ… **Idempotency** - `IdempotencyService`, `IdempotencyFilter`, cleanup job all exist
2. âœ… **SpEL Security** - `SpelValidatorServiceImpl` with `SimpleEvaluationContext`
3. âœ… **HexagonalArchitectureTest** - Test file exists and passes

**Lesson:** Always verify what's already done before implementing!

### What Stayed (Critical Gaps)

1. ğŸ”´ **Testing Coverage** - Still only 21.8%, needs 75%+
2. âš ï¸ **Exception Handling** - Inconsistent, needs standardization
3. âš ï¸ **Structured Logging** - No MDC context
4. âœ… **Documentation** - Runbooks, ADRs

---

## ğŸ”„ How to Proceed

### Step 1: Verify Current State âœ… (Already Done)

```powershell
# Application running?
curl http://localhost:8080/actuator/health

# E2E tests passing?
.\scripts\test-complete-flow.ps1

# Commit clean?
git status  # Should show: "working tree clean"
```

**Status:** âœ… All verified, application working perfectly.

### Step 2: Review Epic 10 v2 Documentation ğŸ“–

Read these files in order:
1. `docs/EPIC-10-QUALITY-TESTING-EXCELLENCE.md` - Epic overview
2. `docs/stories/STORY-10.1-TESTING-COVERAGE-75.md` - Detailed story
3. `docs/EPIC-10-CHECKLIST.md` - Tracking checklist

### Step 3: Start Implementation ğŸš€

**Week 1: Domain Layer Tests**

```powershell
# Create first test
# File: src/test/java/com/bank/signature/domain/model/entity/SignatureRequestTest.java

# Run test
mvn test -Dtest=SignatureRequestTest

# Check coverage
mvn jacoco:report
# Open: target/site/jacoco/index.html
```

**Important Rules:**
- âœ… One test file at a time
- âœ… Run tests after each file
- âœ… Commit when tests pass
- âœ… NO Composer - manual implementation only

---

## ğŸ” Reviewing Epic 10 v1 (If Needed)

### Scenario: You Want to See Error Code Catalog from v1

```powershell
# Don't apply stash! Just view:
git stash show stash@{0} -p -- src/main/java/com/bank/signature/application/service/ErrorCodeCatalog.java > temp-review.txt

# Review the file
code temp-review.txt

# If you like it, manually re-create it
# DON'T: git stash apply (would bring all broken code)
```

### Scenario: You Want to Check Database Constraints

```powershell
git stash show stash@{0} -p -- src/main/resources/liquibase/changes/dev/0011-add-database-constraints.yaml
```

### Scenario: You're Curious What Broke

```powershell
# See all changed files
git stash show stash@{0} --name-status

# See specific test that was broken
git stash show stash@{0} -p -- src/test/java/com/bank/signature/infrastructure/adapter/outbound/persistence/DatabaseConstraintsIntegrationTest.java
```

---

## âš ï¸ Important Warnings

### Don't Apply the Stash

```powershell
# âŒ NEVER DO THIS:
git stash apply stash@{0}  # Would break everything again

# âŒ NEVER DO THIS:
git stash pop stash@{0}    # Even worse - can't undo

# âœ… DO THIS INSTEAD:
git stash show stash@{0} -p -- specific/file.java  # View only
```

### Don't Trust Composer for Critical Work

Epic 10 v1 failed because Composer:
- Made assumptions without verification
- Wrote tests that didn't execute
- Created code without checking existing implementation
- No incremental validation

**For Epic 10 v2:** Use Cursor normal mode, write tests manually, verify each one.

---

## ğŸ“Š Progress Comparison

### Epic 10 v1 (Attempted)
- â±ï¸ **Time Spent:** 3 hours
- âœ… **Working Code:** 0%
- âŒ **Broken Tests:** Many
- ğŸ“ **Files Changed:** 20+
- ğŸ¯ **Value Delivered:** 0

### Epic 10 v2 (Planned)
- â±ï¸ **Time Estimate:** 5-6 weeks
- âœ… **Working Code Target:** 100%
- âŒ **Broken Tests Target:** 0
- ğŸ“ **Files to Change:** ~50 (tests)
- ğŸ¯ **Value Delivered:** Coverage 21.8% â†’ 75%+

---

## ğŸ“ Lessons Learned

### From Epic 10 v1 Failure

1. **Always verify what exists** before implementing
   - Idempotency was already done
   - SpEL security was already done
   - HexagonalArchitectureTest was already there

2. **Composer is not magic**
   - Needs supervision
   - Can make wrong assumptions
   - Tests it writes may not run

3. **Scope matters**
   - 15 stories = too much
   - 4 focused stories = manageable

4. **Incremental progress**
   - Commit after each working feature
   - Run tests continuously
   - Don't accumulate changes

### For Epic 10 v2

1. **Manual implementation** - No auto-pilot
2. **Test each change** - Don't accumulate broken tests
3. **Small commits** - One test file = one commit
4. **Verify coverage** - Run JaCoCo after each day
5. **Document progress** - Update EPIC-10-CHECKLIST.md daily

---

## ğŸ”— Quick Links

- [Epic 10 v2 Overview](EPIC-10-QUALITY-TESTING-EXCELLENCE.md)
- [Story 10.1 Details](stories/STORY-10.1-TESTING-COVERAGE-75.md)
- [Epic 10 Checklist](EPIC-10-CHECKLIST.md)
- [Testing Guide](TESTING-GUIDE.md)
- [Quality Evaluation Report](../EvaluaciÃ³n_de_Calidad_del_Proyecto_Signature_Router.md)

---

## ğŸ’¬ Questions?

### Q: Can I delete the stash?
**A:** Not yet. Keep it for at least 1 month in case you want to reference something.

### Q: Should I implement error codes from v1?
**A:** Review them first (`git stash show ...`), then re-implement manually if they make sense.

### Q: What if I want to use Composer?
**A:** Fine for simple tasks, but for Epic 10 (critical), use manual implementation with supervision.

### Q: When do we start Epic 10 v2?
**A:** When you're ready! Current codebase is stable and working.

---

**Document Created:** 2025-11-29  
**Epic 10 v1 Stashed:** 2025-11-29 14:49:19  
**Epic 10 v2 Planned:** 2025-11-29 15:00:00

