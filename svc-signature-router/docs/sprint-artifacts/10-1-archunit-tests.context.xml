<?xml version="1.0" encoding="UTF-8"?>
<story-context id="signature-router-10-1-context" version="1.0">
  <metadata>
    <epicId>10</epicId>
    <storyId>10.1</storyId>
    <storyKey>10-1-archunit-tests</storyKey>
    <title>ArchUnit Tests - Validación Automatizada de Arquitectura Hexagonal</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-29</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/10-1-archunit-tests.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Developer</asA>
    <iWant>Tests automatizados que validen arquitectura hexagonal</iWant>
    <soThat>No se violen capas arquitectónicas en futuros cambios</soThat>
    
    <context>
      Esta story implementa validación automatizada de arquitectura hexagonal usando ArchUnit, 
      una librería que permite escribir tests que validan reglas arquitectónicas como parte del test suite. 
      Esto previene que desarrolladores introduzcan dependencias incorrectas entre capas, manteniendo 
      la pureza del dominio y la separación de concerns.
      
      Source: Evaluación de Calidad identificó que falta HexagonalArchitectureTest.java mencionado 
      en documentación pero no implementado.
      
      Business Value: Previene degradación arquitectónica, mantiene domain purity (requisito para DDD), 
      facilita refactoring seguro, cumple con estándares bancarios de arquitectura.
    </context>

    <tasks>
      <task id="1" ac="AC1">
        <title>Add ArchUnit Dependency</title>
        <subtasks>
          <subtask id="1.1">Agregar dependencia archunit-junit5:1.2.1 en pom.xml (test scope)</subtask>
          <subtask id="1.2">Ejecutar mvn dependency:resolve para verificar descarga</subtask>
          <subtask id="1.3">Verificar que no hay conflictos de versiones</subtask>
        </subtasks>
        <filesToModify>
          <file>pom.xml</file>
        </filesToModify>
      </task>
      
      <task id="2" ac="AC2,AC3,AC4,AC5,AC6,AC7,AC8">
        <title>Create HexagonalArchitectureTest</title>
        <subtasks>
          <subtask id="2.1">Crear directorio src/test/java/com/bank/signature/architecture/</subtask>
          <subtask id="2.2">Crear clase HexagonalArchitectureTest.java</subtask>
          <subtask id="2.3">Implementar regla: domainLayerShouldNotDependOnInfrastructure</subtask>
          <subtask id="2.4">Implementar regla: domainLayerShouldNotDependOnSpring</subtask>
          <subtask id="2.5">Implementar regla: domainLayerShouldNotDependOnJPA</subtask>
          <subtask id="2.6">Implementar regla: domainLayerShouldNotDependOnJackson</subtask>
          <subtask id="2.7">Implementar regla: applicationLayerShouldNotDependOnInfrastructureAdapters</subtask>
          <subtask id="2.8">Implementar regla: portsShouldBeInterfaces</subtask>
          <subtask id="2.9">Implementar regla: adaptersShouldImplementPorts</subtask>
          <subtask id="2.10">Implementar regla: domainModelsShouldNotHaveJPAAnnotations</subtask>
          <subtask id="2.11">Agregar JavaDoc explicando cada regla</subtask>
          <subtask id="2.12">Ejecutar tests y verificar que pasan</subtask>
        </subtasks>
        <filesToCreate>
          <file>src/test/java/com/bank/signature/architecture/HexagonalArchitectureTest.java</file>
        </filesToCreate>
      </task>
      
      <task id="3" ac="AC9,AC10">
        <title>Verify Tests Pass</title>
        <subtasks>
          <subtask id="3.1">Ejecutar mvn test -Dtest=HexagonalArchitectureTest</subtask>
          <subtask id="3.2">Verificar que todos los tests pasan</subtask>
          <subtask id="3.3">Si hay violaciones, documentarlas y decidir si corregir o ajustar reglas</subtask>
          <subtask id="3.4">Ejecutar suite completa de tests para verificar integración</subtask>
        </subtasks>
      </task>
      
      <task id="4" ac="AC11">
        <title>Update Documentation</title>
        <subtasks>
          <subtask id="4.1">Agregar sección "Architecture Validation" en README.md</subtask>
          <subtask id="4.2">Documentar cómo ejecutar ArchUnit tests</subtask>
          <subtask id="4.3">Agregar ejemplos de violaciones comunes</subtask>
          <subtask id="4.4">Documentar qué hacer si test falla</subtask>
        </subtasks>
        <filesToModify>
          <file>README.md</file>
        </filesToModify>
      </task>
      
      <task id="5" ac="AC9">
        <title>CI/CD Integration Verification</title>
        <subtasks>
          <subtask id="5.1">Verificar que CI/CD ejecuta tests automáticamente</subtask>
          <subtask id="5.2">Verificar que build falla si tests fallan</subtask>
          <subtask id="5.3">Documentar comportamiento en CI/CD docs si aplica</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <title>ArchUnit Dependency Added</title>
      <given>El proyecto Maven</given>
      <when>Reviso pom.xml</when>
      <then>
        Incluye dependencia:
        &lt;dependency&gt;
          &lt;groupId&gt;com.tngtech.archunit&lt;/groupId&gt;
          &lt;artifactId&gt;archunit-junit5&lt;/artifactId&gt;
          &lt;version&gt;1.2.1&lt;/version&gt;
          &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
      </then>
      <verification>mvn dependency:resolve ejecuta exitosamente</verification>
    </criterion>

    <criterion id="AC2">
      <title>HexagonalArchitectureTest Created</title>
      <given>El paquete de tests</given>
      <when>Reviso src/test/java/com/bank/signature/architecture/</when>
      <then>
        Existe HexagonalArchitectureTest.java con:
        - Anotación @AnalyzeClasses(packages = "com.bank.signature")
        - Clase pública con métodos @ArchTest estáticos
        - Mínimo 8 reglas ArchUnit implementadas
      </then>
      <verification>Archivo existe y compila</verification>
    </criterion>

    <criterion id="AC3">
      <title>Domain Layer Purity Validation</title>
      <given>HexagonalArchitectureTest.java</given>
      <when>Ejecuto tests</when>
      <then>
        Valida que domain/ package NO depende de:
        - org.springframework.*
        - javax.persistence.* / jakarta.persistence.*
        - com.fasterxml.jackson.*
        - org.apache.kafka.*
        - ..infrastructure..
      </then>
      <verification>Test falla si se agrega dependencia prohibida</verification>
    </criterion>

    <criterion id="AC4">
      <title>Application Layer Isolation</title>
      <given>HexagonalArchitectureTest.java</given>
      <when>Ejecuto tests</when>
      <then>
        Valida que application/ package NO depende de:
        - ..infrastructure.adapter..
      </then>
      <verification>application/ puede depender de domain/ e infrastructure.config.*</verification>
    </criterion>

    <criterion id="AC5">
      <title>Ports Are Interfaces</title>
      <given>HexagonalArchitectureTest.java</given>
      <when>Ejecuto tests</when>
      <then>Valida que todas las clases en ..domain.port.. son interfaces</then>
      <verification>Test pasa con código actual</verification>
    </criterion>

    <criterion id="AC6">
      <title>Adapters Implement Ports</title>
      <given>HexagonalArchitectureTest.java</given>
      <when>Ejecuto tests</when>
      <then>Valida que clases en ..infrastructure.adapter.. implementan interfaces de ..domain.port..</then>
      <verification>Test pasa con código actual</verification>
    </criterion>

    <criterion id="AC7">
      <title>Unidirectional Dependency Flow</title>
      <given>HexagonalArchitectureTest.java</given>
      <when>Ejecuto tests</when>
      <then>
        Valida flujo unidireccional:
        - Infrastructure → Application → Domain (permitido)
        - Domain → Infrastructure (prohibido)
        - Application → Infrastructure (prohibido, excepto config)
      </then>
      <verification>Test pasa con código actual</verification>
    </criterion>

    <criterion id="AC8">
      <title>Domain Models No JPA Annotations</title>
      <given>HexagonalArchitectureTest.java</given>
      <when>Ejecuto tests</when>
      <then>
        Valida que clases en ..domain.model.. NO tienen anotaciones:
        - @Entity
        - @Table
        - @Column
        - @ManyToOne / @OneToMany
      </then>
      <verification>Test pasa con código actual</verification>
    </criterion>

    <criterion id="AC9">
      <title>Maven Build Integration</title>
      <given>pom.xml</given>
      <when>Ejecuto mvn test</when>
      <then>
        ArchUnit tests ejecutan automáticamente
        Si algún test falla, build falla con error claro
      </then>
      <verification>mvn test ejecuta ArchUnit tests</verification>
    </criterion>

    <criterion id="AC10">
      <title>Tests Pass on Current Codebase</title>
      <given>Código base actual</given>
      <when>Ejecuto mvn test -Dtest=HexagonalArchitectureTest</when>
      <then>Todos los tests pasan (sin violaciones)</then>
      <verification>Output muestra todos los tests pasando</verification>
    </criterion>

    <criterion id="AC11">
      <title>Documentation Updated</title>
      <given>README.md</given>
      <when>Reviso sección "Architecture Validation"</when>
      <then>
        Incluye:
        - Explicación de ArchUnit tests
        - Cómo ejecutar tests manualmente
        - Qué hacer si test falla
        - Ejemplos de violaciones comunes
      </then>
      <verification>README.md contiene sección completa</verification>
    </criterion>
  </acceptanceCriteria>

  <technicalNotes>
    <note>
      ArchUnit se integra automáticamente con JUnit 5. No se requiere configuración especial 
      en pom.xml más allá de la dependencia.
    </note>
    <note>
      Las reglas ArchUnit son tests unitarios que validan estructura de código. 
      No requieren mocks ni setup especial y ejecutan en &lt;5 segundos.
    </note>
    <note>
      Si tests fallan en codebase actual, revisar violaciones y decidir si corregir código 
      o ajustar reglas (preferir corregir código).
    </note>
  </technicalNotes>

  <dependencies>
    <internal>
      <prerequisite>Epic 1 completado (estructura hexagonal existente)</prerequisite>
      <prerequisite>Código base con domain, application, infrastructure layers</prerequisite>
    </internal>
    <external>
      <library>
        <groupId>com.tngtech.archunit</groupId>
        <artifactId>archunit-junit5</artifactId>
        <version>1.2.1</version>
        <scope>test</scope>
      </library>
    </external>
  </dependencies>

  <testStrategy>
    <unitTests>
      ArchUnit tests son tests unitarios que validan estructura de código.
      No requieren mocks ni setup especial.
      Ejecutan en &lt;5 segundos.
    </unitTests>
    <verification>
      Ejecutar mvn test -Dtest=HexagonalArchitectureTest
      Verificar output muestra todos los tests pasando
      Intentar agregar dependencia prohibida y verificar que test falla
    </verification>
  </testStrategy>

  <risks>
    <risk>
      <description>Tests pueden fallar en codebase actual si hay violaciones existentes</description>
      <mitigation>Revisar violaciones y decidir si corregir código o ajustar reglas (preferir corregir código)</mitigation>
    </risk>
    <risk>
      <description>Reglas muy estrictas pueden bloquear desarrollo legítimo</description>
      <mitigation>Reglas basadas en arquitectura hexagonal estándar, ajustar solo si hay necesidad técnica clara</mitigation>
    </risk>
  </risks>

  <references>
    <reference>Epic 10 Tech Spec: docs/sprint-artifacts/tech-spec-epic-10.md</reference>
    <reference>Quality Evaluation: Evaluación_de_Calidad_del_Proyecto_Signature_Router.md</reference>
    <reference>ArchUnit Documentation: https://www.archunit.org/</reference>
    <reference>Hexagonal Architecture Pattern: https://alistair.cockburn.us/hexagonal-architecture/</reference>
  </references>
</story-context>
