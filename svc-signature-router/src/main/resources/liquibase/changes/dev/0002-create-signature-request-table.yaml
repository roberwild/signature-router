databaseChangeLog:
  - changeSet:
      id: "0002"
      author: "BMAD Dev Agent <bmad@signature-router.com>"
      context: dev
      comment: "Create signature_request table - Aggregate root for signature requests"
      changes:
        - createTable:
            tableName: signature_request
            columns:
              - column:
                  name: id
                  type: uuid
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: customer_id
                  type: varchar(255)
                  constraints:
                    nullable: false
              - column:
                  name: transaction_context
                  type: jsonb
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: varchar(50)
                  constraints:
                    nullable: false
              - column:
                  name: active_challenge_id
                  type: uuid
              - column:
                  name: created_at
                  type: timestamp with time zone
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: timestamp with time zone
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: expires_at
                  type: timestamp with time zone
                  constraints:
                    nullable: false
        
        # CHECK constraint for status values (using SQL for compatibility)
        - sql:
            sql: "ALTER TABLE signature_request ADD CONSTRAINT chk_signature_request_status CHECK (status IN ('PENDING', 'CHALLENGED', 'SIGNED', 'FAILED', 'EXPIRED', 'ABORTED'));"
        
        # B-tree index on customer_id (frequent queries)
        - createIndex:
            indexName: idx_signature_request_customer_id
            tableName: signature_request
            columns:
              - column:
                  name: customer_id
        
        # B-tree index on status (frequent filters)
        - createIndex:
            indexName: idx_signature_request_status
            tableName: signature_request
            columns:
              - column:
                  name: status
        
        # B-tree index on created_at (for time-based queries)
        - createIndex:
            indexName: idx_signature_request_created_at
            tableName: signature_request
            columns:
              - column:
                  name: created_at
        
        # GIN index on JSONB (requires raw SQL, LiquidBase YAML doesn't support USING GIN)
        - sql:
            sql: "CREATE INDEX idx_signature_request_context_gin ON signature_request USING GIN (transaction_context);"
        
        # Table and column comments for documentation
        - sql:
            sql: |
              COMMENT ON TABLE signature_request IS 'Aggregate root for signature requests (DDD)';
              COMMENT ON COLUMN signature_request.customer_id IS 'Pseudonimized customer ID (NOT PII - GDPR compliant)';
              COMMENT ON COLUMN signature_request.transaction_context IS 'Immutable business context in JSONB (amount, riskLevel, etc.)';
              COMMENT ON COLUMN signature_request.active_challenge_id IS 'Single active challenge at a time (business rule)';
      
      rollback:
        - dropTable:
            tableName: signature_request
            cascade: true

