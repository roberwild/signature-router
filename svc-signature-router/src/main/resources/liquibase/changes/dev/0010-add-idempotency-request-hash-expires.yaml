databaseChangeLog:
  - changeSet:
      id: 10.5-add-idempotency-request-hash-expires
      author: signature-router-team
      context: dev
      comment: "Story 10.5: Add request_hash and expires_at columns to idempotency_record table"
      changes:
        - addColumn:
            tableName: idempotency_record
            columns:
              - column:
                  name: request_hash
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
                  defaultValue: ''
                  remarks: "SHA-256 hash of request body for conflict detection"
              
              - column:
                  name: expires_at
                  type: TIMESTAMP WITH TIME ZONE
                  constraints:
                    nullable: false
                  defaultValueComputed: "CURRENT_TIMESTAMP + INTERVAL '24 hours'"
                  remarks: "Expiration timestamp (TTL: 24h from creation)"
        
        - createIndex:
            indexName: idx_idempotency_key
            tableName: idempotency_record
            columns:
              - column:
                  name: idempotency_key
            remarks: "Index for fast lookup by idempotency key"
        
        - createIndex:
            indexName: idx_idempotency_expires_at
            tableName: idempotency_record
            columns:
              - column:
                  name: expires_at
            remarks: "Index for cleanup job (delete expired records)"
        
        # Update existing records to have default values
        - sql:
            sql: |
              UPDATE idempotency_record 
              SET request_hash = '', 
                  expires_at = created_at + INTERVAL '24 hours'
              WHERE request_hash IS NULL OR expires_at IS NULL
      
      rollback:
        - dropIndex:
            indexName: idx_idempotency_expires_at
            tableName: idempotency_record
        - dropIndex:
            indexName: idx_idempotency_key
            tableName: idempotency_record
        - dropColumn:
            tableName: idempotency_record
            columns:
              - column:
                  name: expires_at
              - column:
                  name: request_hash

