databaseChangeLog:
  - changeSet:
      id: "0005"
      author: "BMAD Dev Agent <bmad@signature-router.com>"
      context: dev
      comment: "Create connector_config table - Provider configurations with circuit breaker state"
      changes:
        - createTable:
            tableName: connector_config
            columns:
              - column:
                  name: id
                  type: uuid
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: provider
                  type: varchar(100)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: enabled
                  type: boolean
                  defaultValueBoolean: true
                  constraints:
                    nullable: false
              - column:
                  name: config
                  type: jsonb
                  constraints:
                    nullable: false
              - column:
                  name: vault_path
                  type: varchar(255)
                  constraints:
                    nullable: false
              - column:
                  name: degraded_mode
                  type: boolean
                  defaultValueBoolean: false
              - column:
                  name: degraded_since
                  type: timestamp with time zone
              - column:
                  name: error_rate
                  type: numeric(5,2)
              - column:
                  name: last_health_check
                  type: timestamp with time zone
              - column:
                  name: created_at
                  type: timestamp with time zone
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: timestamp with time zone
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        
        # GIN index on JSONB config column for efficient queries
        - sql:
            sql: "CREATE INDEX idx_connector_config_config_gin ON connector_config USING GIN (config);"
        
        # Index on provider (unique constraint already creates index, but explicit for clarity)
        - createIndex:
            indexName: idx_connector_config_provider
            tableName: connector_config
            columns:
              - column:
                  name: provider
        
        # Table and column comments
        - sql:
            sql: |
              COMMENT ON TABLE connector_config IS 'Provider configurations (Twilio, Push, etc.) with circuit breaker state';
              COMMENT ON COLUMN connector_config.config IS 'Provider-specific config in JSONB (timeout_ms, retry_attempts, etc.)';
              COMMENT ON COLUMN connector_config.vault_path IS 'HashiCorp Vault path for secrets (API keys, tokens)';
              COMMENT ON COLUMN connector_config.degraded_mode IS 'Circuit breaker state: true = open (degraded), false = closed (healthy)';
              COMMENT ON COLUMN connector_config.error_rate IS 'Current error rate percentage (triggers circuit breaker at >50%)';
      
      rollback:
        - dropTable:
            tableName: connector_config
            cascade: true

