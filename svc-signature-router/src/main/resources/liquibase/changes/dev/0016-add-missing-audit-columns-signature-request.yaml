databaseChangeLog:
  - changeSet:
      id: "0016"
      author: "Claude Code <dev@signature-router.com>"
      context: dev
      comment: "Add missing audit and timeline columns to signature_request table"
      changes:
        # Add routing_timeline JSONB column for audit trail
        - addColumn:
            tableName: signature_request
            columns:
              - column:
                  name: routing_timeline
                  type: jsonb
                  defaultValueComputed: "'[]'::jsonb"
                  constraints:
                    nullable: false
                  remarks: "Audit trail of routing decisions and events (JSON array of RoutingEvent objects)"

        # Add signed_at timestamp for signature completion tracking
        - addColumn:
            tableName: signature_request
            columns:
              - column:
                  name: signed_at
                  type: timestamp with time zone
                  constraints:
                    nullable: true
                  remarks: "Timestamp when signature was successfully completed (NULL if not signed)"

        # Ensure aborted_at exists (should have been added in 0010, but verifying)
        # This is safe - if column exists, it will be skipped
        - addColumn:
            tableName: signature_request
            columns:
              - column:
                  name: aborted_at
                  type: timestamp with time zone
                  constraints:
                    nullable: true
                  remarks: "Timestamp when signature was aborted/cancelled (NULL if not aborted)"
            preConditions:
              onFail: MARK_RAN
              not:
                columnExists:
                  tableName: signature_request
                  columnName: aborted_at

        # Add column comments for documentation
        - sql:
            sql: |
              COMMENT ON COLUMN signature_request.routing_timeline IS 'Complete audit trail of routing events, provider selections, and fallback chains (JSONB array)';
              COMMENT ON COLUMN signature_request.signed_at IS 'Timestamp when signature request reached SIGNED status (business metric)';
              COMMENT ON COLUMN signature_request.aborted_at IS 'Timestamp when signature request was aborted/cancelled by user or system';

        # Create GIN index on routing_timeline for efficient JSONB queries
        - sql:
            sql: "CREATE INDEX IF NOT EXISTS idx_signature_request_routing_timeline_gin ON signature_request USING GIN (routing_timeline);"

      rollback:
        - dropColumn:
            tableName: signature_request
            columnName: routing_timeline
        - dropColumn:
            tableName: signature_request
            columnName: signed_at
        - sql:
            sql: "DROP INDEX IF EXISTS idx_signature_request_routing_timeline_gin;"
