databaseChangeLog:
  - changeSet:
      id: "0006"
      author: "BMAD Dev Agent <bmad@signature-router.com>"
      context: dev
      comment: "Create outbox_event table - Outbox pattern for atomic event publishing (Debezium CDC)"
      changes:
        - createTable:
            tableName: outbox_event
            columns:
              - column:
                  name: id
                  type: uuid
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: aggregate_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: aggregate_type
                  type: varchar(100)
                  constraints:
                    nullable: false
              - column:
                  name: event_type
                  type: varchar(100)
                  constraints:
                    nullable: false
              - column:
                  name: payload
                  type: jsonb
                  constraints:
                    nullable: false
              - column:
                  name: payload_hash
                  type: varchar(64)
              - column:
                  name: created_at
                  type: timestamp with time zone
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: published_at
                  type: timestamp with time zone
        
        # CRITICAL INDEX: Debezium CDC polls for unpublished events (published_at IS NULL)
        - createIndex:
            indexName: idx_outbox_event_published_at
            tableName: outbox_event
            columns:
              - column:
                  name: published_at
        
        # Index on aggregate_id for querying events by signature request
        - createIndex:
            indexName: idx_outbox_event_aggregate_id
            tableName: outbox_event
            columns:
              - column:
                  name: aggregate_id
        
        # GIN index on JSONB payload for event content queries
        - sql:
            sql: "CREATE INDEX idx_outbox_event_payload_gin ON outbox_event USING GIN (payload);"
        
        # Table and column comments
        - sql:
            sql: |
              COMMENT ON TABLE outbox_event IS 'Outbox pattern for atomic event publishing (guarantees state + event in same TX)';
              COMMENT ON COLUMN outbox_event.published_at IS 'NULL = pending, NOT NULL = published by Debezium CDC (Story 1.3)';
              COMMENT ON COLUMN outbox_event.payload_hash IS 'SHA-256 hash for event integrity verification (optional)';
              COMMENT ON COLUMN outbox_event.aggregate_id IS 'signature_request.id (partition key for Kafka)';
      
      rollback:
        - dropTable:
            tableName: outbox_event
            cascade: true

