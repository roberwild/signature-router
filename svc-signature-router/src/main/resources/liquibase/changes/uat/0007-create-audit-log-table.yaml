databaseChangeLog:
  - changeSet:
      id: "0007"
      author: "BMAD Dev Agent <bmad@signature-router.com>"
      context: uat
      comment: "Create audit_log table - Audit trail for PCI-DSS / SOC 2 compliance"
      changes:
        - createTable:
            tableName: audit_log
            columns:
              - column:
                  name: id
                  type: uuid
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: entity_type
                  type: varchar(100)
                  constraints:
                    nullable: false
              - column:
                  name: entity_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: action
                  type: varchar(50)
                  constraints:
                    nullable: false
              - column:
                  name: user_id
                  type: varchar(255)
              - column:
                  name: ip_address
                  type: varchar(45)
              - column:
                  name: changes
                  type: jsonb
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: timestamp with time zone
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        
        # Index on created_at for time-based queries and data retention (partitioning ready)
        - createIndex:
            indexName: idx_audit_log_created_at
            tableName: audit_log
            columns:
              - column:
                  name: created_at
        
        # Composite index on entity_type + entity_id for audit trail queries
        - createIndex:
            indexName: idx_audit_log_entity
            tableName: audit_log
            columns:
              - column:
                  name: entity_type
              - column:
                  name: entity_id
        
        # GIN index on changes JSONB for detailed audit queries
        - sql:
            sql: "CREATE INDEX idx_audit_log_changes_gin ON audit_log USING GIN (changes);"
        
        # Table and column comments
        - sql:
            sql: |
              COMMENT ON TABLE audit_log IS 'Audit trail for all changes (PCI-DSS, SOC 2 compliance) - partitioned by month in production';
              COMMENT ON COLUMN audit_log.entity_type IS 'Type of entity changed (SignatureRequest, RoutingRule, etc.)';
              COMMENT ON COLUMN audit_log.action IS 'Action performed (INSERT, UPDATE, DELETE, etc.)';
              COMMENT ON COLUMN audit_log.changes IS 'JSONB with before/after values for change tracking';
              COMMENT ON COLUMN audit_log.ip_address IS 'IPv4 or IPv6 address (max 45 chars for IPv6)';
      
      rollback:
        - dropTable:
            tableName: audit_log
            cascade: true

