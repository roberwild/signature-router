databaseChangeLog:
  - changeSet:
      id: 0015-create-provider-config-table
      author: dev-team
      context: prod
      comment: |
        Story 13.1: Provider Database Schema & Migration
        Epic 13: Providers CRUD Management
        
        Creates provider_config table for dynamic provider management.
        Replaces static YAML configuration with database-driven configuration.
        
        Features:
        - Dynamic provider configuration without service restart
        - Support for multiple provider types (SMS, PUSH, VOICE, BIOMETRIC)
        - JSONB for flexible provider-specific configuration
        - Vault integration for secure credential storage
        - Priority-based ordering for fallback chains
      changes:
        - createTable:
            tableName: provider_config
            remarks: "Dynamic provider configuration - replaces static YAML config"
            columns:
              # Primary Key
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: uuidv7()
                  remarks: "UUIDv7 primary key (time-sortable)"
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_provider_config
                    nullable: false
              
              # Provider Identification
              - column:
                  name: provider_type
                  type: VARCHAR(20)
                  remarks: "Provider type: SMS, PUSH, VOICE, BIOMETRIC"
                  constraints:
                    nullable: false
              
              - column:
                  name: provider_name
                  type: VARCHAR(100)
                  remarks: "Human-readable provider name (e.g., 'Twilio SMS Production')"
                  constraints:
                    nullable: false
              
              - column:
                  name: provider_code
                  type: VARCHAR(50)
                  remarks: "Unique code for programmatic reference (e.g., 'twilio-sms-prod')"
                  constraints:
                    nullable: false
                    unique: true
                    uniqueConstraintName: uk_provider_config_code
              
              # Configuration
              - column:
                  name: enabled
                  type: BOOLEAN
                  defaultValueBoolean: true
                  remarks: "Enable/disable provider (soft delete)"
                  constraints:
                    nullable: false
              
              - column:
                  name: priority
                  type: INTEGER
                  remarks: "Priority for fallback chain (1 = highest priority)"
                  constraints:
                    nullable: false
              
              - column:
                  name: timeout_seconds
                  type: INTEGER
                  defaultValueNumeric: 5
                  remarks: "API timeout in seconds"
                  constraints:
                    nullable: false
              
              - column:
                  name: retry_max_attempts
                  type: INTEGER
                  defaultValueNumeric: 3
                  remarks: "Maximum retry attempts on failure"
                  constraints:
                    nullable: false
              
              # Provider-specific Configuration (JSONB)
              - column:
                  name: config_json
                  type: JSONB
                  remarks: "Provider-specific configuration (flexible schema)"
                  constraints:
                    nullable: false
              
              # Vault Integration
              - column:
                  name: vault_path
                  type: VARCHAR(500)
                  remarks: "Path to credentials in HashiCorp Vault"
                  constraints:
                    nullable: false
              
              # Audit Fields
              - column:
                  name: created_at
                  type: TIMESTAMPTZ
                  defaultValueComputed: CURRENT_TIMESTAMP
                  remarks: "Creation timestamp"
                  constraints:
                    nullable: false
              
              - column:
                  name: updated_at
                  type: TIMESTAMPTZ
                  defaultValueComputed: CURRENT_TIMESTAMP
                  remarks: "Last update timestamp"
                  constraints:
                    nullable: false
              
              - column:
                  name: created_by
                  type: VARCHAR(100)
                  remarks: "User who created the provider (email/username)"
              
              - column:
                  name: updated_by
                  type: VARCHAR(100)
                  remarks: "User who last updated the provider"
        
        # Constraints
        - addCheckConstraint:
            tableName: provider_config
            constraintName: ck_provider_type
            checkCondition: "provider_type IN ('SMS', 'PUSH', 'VOICE', 'BIOMETRIC')"
        
        - addCheckConstraint:
            tableName: provider_config
            constraintName: ck_priority_positive
            checkCondition: "priority > 0"
        
        - addCheckConstraint:
            tableName: provider_config
            constraintName: ck_timeout_positive
            checkCondition: "timeout_seconds > 0"
        
        - addCheckConstraint:
            tableName: provider_config
            constraintName: ck_retry_nonnegative
            checkCondition: "retry_max_attempts >= 0"
        
        # Indexes for Performance
        - createIndex:
            tableName: provider_config
            indexName: idx_provider_config_type
            columns:
              - column:
                  name: provider_type
        
        - createIndex:
            tableName: provider_config
            indexName: idx_provider_config_enabled
            columns:
              - column:
                  name: enabled
        
        - createIndex:
            tableName: provider_config
            indexName: idx_provider_config_priority
            columns:
              - column:
                  name: priority
        
        # Composite index for common query pattern
        - createIndex:
            tableName: provider_config
            indexName: idx_provider_config_type_enabled_priority
            columns:
              - column:
                  name: provider_type
              - column:
                  name: enabled
              - column:
                  name: priority
        
        # GIN index for JSONB queries
        - sql:
            sql: CREATE INDEX idx_provider_config_json ON provider_config USING GIN (config_json);
            comment: "GIN index for fast JSONB queries"
      
      rollback:
        - dropTable:
            tableName: provider_config
            cascadeConstraints: true

  - changeSet:
      id: 0015-create-provider-config-history-table
      author: dev-team
      context: prod
      comment: |
        Story 13.1: Provider Config History Table
        
        Audit trail for all provider configuration changes.
        Tracks CREATE, UPDATE, DELETE, ENABLE, DISABLE actions.
        Stores diff of changes for compliance and troubleshooting.
      changes:
        - createTable:
            tableName: provider_config_history
            remarks: "Audit trail for provider configuration changes"
            columns:
              # Primary Key
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: uuidv7()
                  remarks: "UUIDv7 primary key"
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_provider_config_history
                    nullable: false
              
              # Foreign Key to Provider
              - column:
                  name: provider_config_id
                  type: UUID
                  remarks: "Reference to provider_config (retained even if provider deleted)"
                  constraints:
                    nullable: false
              
              # Action Type
              - column:
                  name: action
                  type: VARCHAR(20)
                  remarks: "Action performed: CREATE, UPDATE, DELETE, ENABLE, DISABLE, TEST"
                  constraints:
                    nullable: false
              
              # Change Details
              - column:
                  name: changes_json
                  type: JSONB
                  remarks: "Diff of changes (before/after values)"
              
              - column:
                  name: reason
                  type: TEXT
                  remarks: "Optional reason for change (entered by user)"
              
              # Audit Fields
              - column:
                  name: changed_by
                  type: VARCHAR(100)
                  remarks: "User who made the change"
                  constraints:
                    nullable: false
              
              - column:
                  name: changed_at
                  type: TIMESTAMPTZ
                  defaultValueComputed: CURRENT_TIMESTAMP
                  remarks: "When the change was made"
                  constraints:
                    nullable: false
              
              # Context
              - column:
                  name: ip_address
                  type: VARCHAR(50)
                  remarks: "IP address of the user who made the change"
              
              - column:
                  name: user_agent
                  type: VARCHAR(500)
                  remarks: "User agent (browser/API client)"
        
        # Constraints
        - addCheckConstraint:
            tableName: provider_config_history
            constraintName: ck_history_action
            checkCondition: "action IN ('CREATE', 'UPDATE', 'DELETE', 'ENABLE', 'DISABLE', 'TEST')"
        
        # Indexes
        - createIndex:
            tableName: provider_config_history
            indexName: idx_provider_history_config_id
            columns:
              - column:
                  name: provider_config_id
        
        - createIndex:
            tableName: provider_config_history
            indexName: idx_provider_history_action
            columns:
              - column:
                  name: action
        
        - createIndex:
            tableName: provider_config_history
            indexName: idx_provider_history_changed_at
            columns:
              - column:
                  name: changed_at
                  descending: true
        
        - createIndex:
            tableName: provider_config_history
            indexName: idx_provider_history_changed_by
            columns:
              - column:
                  name: changed_by
        
        # GIN index for JSONB queries
        - sql:
            sql: CREATE INDEX idx_provider_history_changes_json ON provider_config_history USING GIN (changes_json);
      
      rollback:
        - dropTable:
            tableName: provider_config_history
            cascadeConstraints: true

  - changeSet:
      id: 0015-seed-initial-providers
      author: dev-team
      context: prod
      comment: |
        Story 13.1: Seed Initial Providers (DEV only)
        
        Migrates existing static YAML providers to database.
        Creates 4 providers: Twilio SMS, FCM Push, Twilio Voice, Biometric.
      changes:
        # Twilio SMS Provider
        - insert:
            tableName: provider_config
            columns:
              - column:
                  name: id
                  valueComputed: uuidv7()
              - column:
                  name: provider_type
                  value: SMS
              - column:
                  name: provider_name
                  value: Twilio SMS
              - column:
                  name: provider_code
                  value: twilio-sms
              - column:
                  name: enabled
                  valueBoolean: true
              - column:
                  name: priority
                  valueNumeric: 1
              - column:
                  name: timeout_seconds
                  valueNumeric: 5
              - column:
                  name: retry_max_attempts
                  valueNumeric: 3
              - column:
                  name: config_json
                  value: '{"api_url": "https://api.twilio.com/2010-04-01", "from_number": "+1234567890"}'
              - column:
                  name: vault_path
                  value: secret/signature-router/providers/twilio-sms
              - column:
                  name: created_by
                  value: system-migration
        
        # Firebase Cloud Messaging Provider (PUSH)
        - insert:
            tableName: provider_config
            columns:
              - column:
                  name: id
                  valueComputed: uuidv7()
              - column:
                  name: provider_type
                  value: PUSH
              - column:
                  name: provider_name
                  value: Firebase Cloud Messaging
              - column:
                  name: provider_code
                  value: fcm-push
              - column:
                  name: enabled
                  valueBoolean: true
              - column:
                  name: priority
                  valueNumeric: 1
              - column:
                  name: timeout_seconds
                  valueNumeric: 3
              - column:
                  name: retry_max_attempts
                  valueNumeric: 2
              - column:
                  name: config_json
                  value: '{"api_url": "https://fcm.googleapis.com/fcm/send"}'
              - column:
                  name: vault_path
                  value: secret/signature-router/providers/fcm-push
              - column:
                  name: created_by
                  value: system-migration
        
        # Twilio Voice Provider (disabled by default - expensive)
        - insert:
            tableName: provider_config
            columns:
              - column:
                  name: id
                  valueComputed: uuidv7()
              - column:
                  name: provider_type
                  value: VOICE
              - column:
                  name: provider_name
                  value: Twilio Voice
              - column:
                  name: provider_code
                  value: twilio-voice
              - column:
                  name: enabled
                  valueBoolean: false
              - column:
                  name: priority
                  valueNumeric: 2
              - column:
                  name: timeout_seconds
                  valueNumeric: 10
              - column:
                  name: retry_max_attempts
                  valueNumeric: 2
              - column:
                  name: config_json
                  value: '{"api_url": "https://api.twilio.com/2010-04-01", "tts_language": "es-ES", "tts_voice": "Polly.Mia", "max_call_duration": 60}'
              - column:
                  name: vault_path
                  value: secret/signature-router/providers/twilio-voice
              - column:
                  name: created_by
                  value: system-migration
        
        # Biometric Provider (stub - disabled)
        - insert:
            tableName: provider_config
            columns:
              - column:
                  name: id
                  valueComputed: uuidv7()
              - column:
                  name: provider_type
                  value: BIOMETRIC
              - column:
                  name: provider_name
                  value: Biometric Authentication
              - column:
                  name: provider_code
                  value: biometric-auth
              - column:
                  name: enabled
                  valueBoolean: false
              - column:
                  name: priority
                  valueNumeric: 1
              - column:
                  name: timeout_seconds
                  valueNumeric: 3
              - column:
                  name: retry_max_attempts
                  valueNumeric: 0
              - column:
                  name: config_json
                  value: '{}'
              - column:
                  name: vault_path
                  value: secret/signature-router/providers/biometric-auth
              - column:
                  name: created_by
                  value: system-migration
      
      rollback:
        - delete:
            tableName: provider_config
            where: created_by = 'system-migration'

