databaseChangeLog:
  - changeSet:
      id: "0017"
      author: "Claude Code <dev@signature-router.com>"
      context: prod
      comment: "Add completed_at column to signature_challenge table for audit completeness"
      changes:
        # Add completed_at timestamp for challenge completion tracking
        - addColumn:
            tableName: signature_challenge
            columns:
              - column:
                  name: completed_at
                  type: timestamp with time zone
                  constraints:
                    nullable: true
                  remarks: "Timestamp when challenge was completed (NULL if not completed). Complements responded_at for full audit trail."

        # Add column comment for documentation
        - sql:
            sql: |
              COMMENT ON COLUMN signature_challenge.completed_at IS 'Timestamp when challenge status changed to COMPLETED (audit trail). Note: responded_at captures user response time, completed_at captures system processing completion.';

        # Create B-tree index on completed_at for time-based queries
        - createIndex:
            indexName: idx_signature_challenge_completed_at
            tableName: signature_challenge
            columns:
              - column:
                  name: completed_at

      rollback:
        - dropIndex:
            indexName: idx_signature_challenge_completed_at
            tableName: signature_challenge
        - dropColumn:
            tableName: signature_challenge
            columnName: completed_at
